name: ci/bdd-tests

on:
  workflow_run:
    workflows: [ "ci/integration-tests" ]
    types: [ completed ]
    branches: [ main ]
  pull_request:
    types: [ opened, reopened, synchronize ]

permissions:
  contents: read
  pull-requests: write

jobs:
  godog:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'pull_request'

    services:
      dynamodb-local:
        image: amazon/dynamodb-local:2.5.2
        ports:
          - 8000:8000
        options: >-
          --health-cmd "curl -f http://localhost:8000/shell || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true

      - name: ï¸ Create .env file
        run: cp .env.example .env

      - name: Wait for DynamoDB to be ready
        run: |
          echo "Waiting for DynamoDB to be ready..."
          timeout 60s bash -c 'until curl -f http://localhost:8000/ > /dev/null 2>&1; do sleep 2; done'
          echo "DynamoDB is ready!"

      - name: ðŸ“¦ Download Go modules
        run: go mod download

      - name: ðŸ§ª Run BDD tests
        id: bdd-tests
        run: make bdd-test
        continue-on-error: true
        env:
          DYNAMODB_TABLE_NAME: tc4-customer-service-test-customers
          DYNAMODB_REGION: us-east-1
          TEST_DYNAMODB_ENDPOINT: http://localhost:8000
          # Testcontainers configuration for CI
          TESTCONTAINERS_RYUK_DISABLED: true
          TESTCONTAINERS_CHECKS_DISABLE: true

      - name: ðŸ“Š Upload test results and logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bdd-test-results
          path: |
            tests/features/
            tests/*.go
            *.log
          retention-days: 7

      - name: ðŸ“‹ Generate BDD test summary
        if: always()
        id: test-summary
        run: |
          # Determine test status based on BDD test step outcome
          if [ "${{ steps.bdd-tests.outcome }}" = "success" ]; then
            TEST_STATUS="âœ… PASSED"
            STATUS_ICON="âœ…"
          else
            TEST_STATUS="âŒ FAILED"
            STATUS_ICON="âŒ"
          fi
          
          # Create test summary
          cat > bdd_summary.md << EOF
          ## ðŸ§ª BDD Test Results
          
          **Status:** $TEST_STATUS
          
          ### ðŸ“ Feature Files Tested:
          - **Customer Management** (\`customer_auth.feature\`, \`customer_management.feature\`)
          
          ### ðŸŽ¯ Test Scenarios:
          - $STATUS_ICON **Customer Authentication** - Tests CPF-based customer authentication
          - $STATUS_ICON **Create a new customer** - Tests customer creation functionality
          - $STATUS_ICON **Retrieve customer data** - Tests customer retrieval by ID and CPF
          - $STATUS_ICON **Update customer information** - Tests customer data updates
          - $STATUS_ICON **Delete customer** - Tests customer deletion functionality
          
          ### ðŸ”§ Test Framework:
          - **BDD Framework:** Gherkin + Godog
          - **Database:** DynamoDB Local
          - **Test Environment:** Mock HTTP handlers with Gin
          
          ---
          _Automated BDD tests ensure business requirements are met through behavior-driven scenarios._
          EOF
          
          # Also add to step summary
          cat bdd_summary.md >> $GITHUB_STEP_SUMMARY
          
          # Set output for PR comment
          echo "SUMMARY_CONTENT<<EOF" >> $GITHUB_OUTPUT
          cat bdd_summary.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ Comment BDD test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-tag: bdd-test-results
          message: ${{ steps.test-summary.outputs.SUMMARY_CONTENT }}